---
domain: 6_quality
title: Risk Controls
description: This document explains how the dynamic risk engine, account limits and daily
keywords: 6 quality, readme
last_updated: 2026-01-06
---

# Risk Controls

This document explains how the dynamic risk engine, account limits and daily
reporting features interact across the `order-router` and `reports` services.

## Order Router Risk Engine

The router now relies on a configurable rule engine defined in
`services/order-router/app/risk_rules.py`. The engine evaluates every order
against a set of pluggable rules and produces **alerts** or **locks**:

- **DynamicLimitRule** keeps per-account and per-symbol limits in sync with
  executed orders. It issues warnings when utilisation exceeds 80% of the
  configured notional and blocks orders that would breach the position or
  notional limit.
- **StopLossRule** enforces account level stop-losses based on realised and
  unrealised P&L. Thresholds can be set globally or overridden per request.
- **MaxDailyLossRule** maintains compatibility with the legacy projected loss
  guard.
- **MaxNotionalRule** keeps the original static notional checks for venues
  that do not publish dynamic limits yet.

Each rule returns a `RiskSignal` with a level:

- `alert` signals are logged and can be retrieved via `GET /risk/alerts`.
- `lock` signals stop the order immediately and surface the reason through the
  API.

### Configuring limits and stop-losses

The router initialises a `DynamicLimitStore` with sandbox limits sourced from
`providers.limits`. Accounts inherit these defaults and can override the
stop-loss threshold dynamically by including a `risk` block in the order
payload:

```json
{
  "broker": "binance",
  "venue": "binance.spot",
  "symbol": "BTCUSDT",
  "side": "buy",
  "quantity": 0.5,
  "order_type": "limit",
  "price": 29500,
  "risk": {
    "account_id": "desk-42",
    "realized_pnl": -1500,
    "unrealized_pnl": -200,
    "stop_loss": 5000
  }
}
```

If `account_id` is also supplied at the top level it takes precedence. When a
`stop_loss` is present the router updates the persistent threshold for the
account before processing the order.

### Inspecting alerts

Risk alerts raised by non-blocking rules are appended to an in-memory log. The
log can be queried via `GET /risk/alerts` and contains the rule identifier,
message and metadata explaining the trigger context. Alerts are also emitted to
service logs under the `order-router.risk` logger.

## Daily Risk Reporting

The reports service exposes a new endpoint `GET /reports/daily` that aggregates
P&L, running drawdown and loss incidents per trading day and account. Results
can be filtered and exported as CSV by providing the `export=csv` query
parameter.

Daily summaries are generated by `DailyRiskCalculator`, which groups entries
from `ReportDaily` by account/date, tracks cumulative P&L to derive drawdown
and records every losing trade as an incident for auditability.

### Example usage

```
GET /reports/daily?account=desk-42&limit=10
GET /reports/daily?export=csv
```

The CSV export includes the session date, account identifier, total daily P&L,
maximum drawdown observed up to that session and a semicolon-separated list of
incidents in the form `SYMBOL:STRATEGY:OUTCOME`.
